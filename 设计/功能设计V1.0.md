# 博客系统功能设计文档（后端 Spring Boot / JDK21 / MySQL / MyBatis，前端 Vite + Element）

## 1. 目标与范围

本系统是一个可多用户使用的博客平台，包含：

* 账号体系：注册/登录、管理员与普通用户区分、权限控制与用户隔离
* 内容体系：支持 **Markdown** 与 **富文本** 两种编辑器；按文章类型分别渲染展示
* 订阅体系：RSS 订阅文章
* 媒体体系：摄影集/相册；管理员可将图片自动上传到 Git/Gitee 作为图床
* 自定义：管理员可注入自定义 CSS/JS
* 互动：评论与回复（楼中楼）
* 主题：按规则制作主题；主题导入/导出，整体改变界面与样式
* 导航：首页导航与页面管理；可选搜索引擎、点击跳转

> 本文只做**功能设计与行为约束**（不做字段表结构设计），目标是实现时“没有歧义、不会漏功能”。

---

## 2. 角色模型与权限控制

### 2.1 角色定义

* **游客（Guest）**：未登录用户
* **普通用户（User）**：注册登录后的用户
* **管理员（Admin）**：拥有后台管理能力的用户

> 可选扩展（不强制）：编辑（Editor）、运营（Moderator）等。但本设计以 Admin/User 为核心。

### 2.2 权限粒度与控制原则

* 后端采用 **RBAC（角色）+ 资源级策略（文章/页面/相册可见性）** 的组合：

  * RBAC：决定“能不能访问某个功能入口/接口”
  * 资源策略：决定“对某条文章/某个页面/某个相册能不能读/评/改”

* 权限判定顺序建议：

  1. 身份：Guest / User / Admin
  2. 功能权限（RBAC）
  3. 资源可见性策略（Visibility Policy）
  4. 资源归属（Owner/Author/Workspace）

### 2.3 核心资源可见性（文章/页面/相册统一适用）

每个内容资源都支持以下可见性策略（至少支持前 4 项）：

1. **PUBLIC**：所有人可查看（含游客）
2. **LOGIN_ONLY**：仅登录用户可查看
3. **WHITELIST**：仅允许指定用户/用户组查看
4. **PRIVATE**：仅作者本人可查看
5. **ADMIN_ONLY**：仅管理员可查看（管理员私有）

> 你提到“普通用户也具备查看博文权限”，通过 PUBLIC/LOGIN_ONLY 即可满足；同时也允许作者控制是否公开或管理员私有。

### 2.4 权限矩阵（关键点）

| 功能/动作            | Guest    | User              | Admin        |
| ---------------- | -------- | ----------------- | ------------ |
| 查看文章（PUBLIC）     | ✅        | ✅                 | ✅            |
| 查看文章（LOGIN_ONLY） | ❌        | ✅                 | ✅            |
| 查看文章（WHITELIST）  | ❌        | ✅（在名单内）           | ✅            |
| 查看文章（PRIVATE）    | ❌        | ✅（仅作者本人）          | ✅（可配置是否强制可见） |
| 查看文章（ADMIN_ONLY） | ❌        | ❌                 | ✅            |
| RSS 获取（公共 feed）  | ✅        | ✅                 | ✅            |
| RSS 获取（登录 feed）  | ❌        | ✅（带 token 或登录态）   | ✅            |
| 发表评论             | 可选（默认 ❌） | ✅                 | ✅            |
| 回复评论             | 可选（默认 ❌） | ✅                 | ✅            |
| 删除自己评论           | ❌        | ✅（仅本人）            | ✅（全局）        |
| 发布文章             | ❌        | ✅（若允许用户发文）        | ✅            |
| 编辑文章             | ❌        | ✅（仅本人 & 草稿/可编辑状态） | ✅            |
| 管理主题/自定义CSS/JS   | ❌        | ❌                 | ✅            |
| 管理导航/页面          | ❌        | ❌                 | ✅            |
| 相册上传/图床同步        | ❌        | ❌（可选允许）           | ✅            |
| 后台审核/封禁/敏感词      | ❌        | ❌                 | ✅            |

> **可配置项建议**：是否允许游客评论、是否允许普通用户发文/建相册、Admin 是否能看到 PRIVATE 内容等，均做成系统配置。

---

## 3. 用户与认证模块

### 3.1 注册

* 注册方式：用户名/邮箱 + 密码（可扩展短信/第三方 OAuth）
* 约束：

  * 用户名唯一
  * 邮箱唯一（若启用邮箱）
  * 密码强度策略（最少长度、复杂度）
* 可选流程：

  * 邮箱验证激活
  * 注册后默认角色为 User

### 3.2 登录

* 支持方式（二选一或兼容）：

  1. **JWT（推荐）**：前端保存 access_token + refresh_token；后端无状态
  2. Session（可行）：后端维护 session

* 安全要求：

  * 密码存储必须使用强哈希（BCrypt/Argon2 等）
  * 登录错误次数限制（防爆破）
  * Refresh Token 可撤销（黑名单或持久化）

### 3.3 管理员能力

* Admin 能：

  * 管理用户（禁用/启用/重置密码/角色变更）
  * 全局配置（站点设置、主题、导航、评论审核、图床配置等）

---

## 4. 博文模块（Markdown / 富文本双模式）

### 4.1 发布与编辑

* 文章支持两种内容类型：

  * **MARKDOWN**：存储 Markdown 源文（以及可选的预渲染 HTML 缓存）
  * **RICH_TEXT**：存储富文本 HTML（需过滤与清洗）

* 编辑器要求：

  * Markdown：支持标题、代码块、表格、引用、图片、链接、目录（可选）
  * 富文本：支持基础格式、图片、链接、代码块（可选）

* 文章状态（建议至少支持）：

  * 草稿（DRAFT）
  * 已发布（PUBLISHED）
  * 已下线（ARCHIVED/UNPUBLISHED）

### 4.2 阅读渲染规则（必须明确，避免歧义）

* 阅读接口返回时，需要明确返回：

  * 文章类型（MARKDOWN / RICH_TEXT）
  * 渲染方式提示（前端按类型选择渲染组件）
* 渲染策略：

  * Markdown：后端可输出 `html`（统一渲染库）或前端自行渲染（保持一致性更推荐后端渲染并缓存）
  * 富文本：直接输出安全清洗后的 HTML（前端以 `v-html` 等方式展示，但必须配合 CSP / 清洗）

### 4.3 文章可见性与“作者控制谁能看”

* 每篇文章具备 **可见性策略**（见 2.3）
* 行为规则：

  * PUBLIC：任何人可读；是否进入 RSS、是否可被搜索引擎索引（另有 SEO 设置）
  * LOGIN_ONLY：仅登录态可读；RSS 若暴露则必须是“登录订阅”
  * WHITELIST：作者/管理员可配置允许用户列表（或分组）
  * PRIVATE：仅作者本人可读；默认不进入 RSS/站内搜索
  * ADMIN_ONLY：仅管理员可读；默认不进入 RSS/站内搜索
* 管理员覆盖规则（建议可配置）：

  * 默认：Admin 可访问所有文章用于审计与排错
  * 可选：对 PRIVATE 不做覆盖（极严格隐私场景）

### 4.4 分类、标签、归档（功能层面）

* 分类：一篇文章可属 0..1（或 0..n，二选一）
* 标签：0..n
* 归档页：按年月聚合文章列表
* 列表页均必须遵守可见性过滤（不能把不可见文章出现在列表里）

### 4.5 搜索

* 最小实现：

  * 基于 MySQL like 的标题/摘要搜索
* 可扩展：

  * Elasticsearch / OpenSearch
* 搜索结果必须做权限过滤（重要）

---

## 5. RSS 订阅模块

### 5.1 RSS 输出范围

至少支持：

* **公共 RSS**：仅包含 PUBLIC 且 PUBLISHED 的文章
* **登录 RSS（可选）**：包含 LOGIN_ONLY/WHITELIST 等可见文章

  * 实现方式建议：`/rss/private?token=xxx`（token 绑定用户，支持吊销与过期）

### 5.2 RSS 内容规范

* 频道信息：站点名称、描述、站点链接、最后更新时间
* item：标题、链接、发布时间、作者、摘要（可选全文内容）
* 摘要来源：

  * Markdown：取前 N 字（去除标记）或渲染后截断
  * 富文本：去标签后截断
* 不可见内容不得出现在 RSS 中（含标题）

---

## 6. 摄影集/相册模块（含 Git/Gitee 图床）

### 6.1 相册能力

* 相册（Album）：

  * 标题、描述、封面、创建者、可见性策略（同 2.3）
* 照片（Photo）：

  * 原图、缩略图、EXIF（可选）、拍摄时间（可选）、标签（可选）
* 展示：

  * 相册列表
  * 相册详情瀑布流/网格
  * 大图预览、上一张/下一张

### 6.2 上传与处理

* 上传入口：Admin（可选允许 User 创建自己的相册）
* 图片处理：

  * 生成缩略图（多尺寸可选）
  * 压缩策略（可配置）
  * EXIF 读取（可选开关，注意隐私：可配置自动去除地理位置）

### 6.3 Git/Gitee 图床自动同步（管理员）

目标：图片最终可通过 Git/Gitee 仓库的 raw/cdn 地址访问。

* 管理配置（Admin）：

  * 选择平台：GitHub / Gitee（你提到 git 或 gitee）
  * 仓库地址、分支、目录前缀（如 `/images/2025/12/`）
  * 认证方式：

    * Personal Access Token（推荐）
    * SSH Key（可选，但部署复杂）
  * 提交信息模板、是否按日期分目录、是否覆盖同名文件

* 上传流程（建议）：

  1. 图片先落地到本地存储（或对象存储）
  2. 生成缩略图
  3. 异步任务将原图/缩略图推送到 Git/Gitee（避免阻塞）
  4. 推送成功后，生成外链 URL 并写回资源记录
  5. 若失败：记录失败原因，支持重试、手动触发同步

* 安全要求：

  * Token 加密存储（配置中心或数据库加密字段）
  * 限制可推送的仓库与路径，避免任意写入

---

## 7. 管理员自定义 CSS / JS

### 7.1 功能定义

* Admin 可在后台填写：

  * 自定义 CSS（全站生效）
  * 自定义 JS（全站生效）

### 7.2 注入时机与作用域

* CSS：

  * 注入到 `<head>` 的 `<style id="custom-css">`
  * 允许覆盖主题样式
* JS：

  * 注入到页面底部（或 head 但建议底部）
  * 需要明确：JS 具备全站权限，可能造成安全问题

### 7.3 安全控制（强制建议）

* JS 默认关闭，仅在配置中显式启用
* 建议提供：

  * 版本管理与回滚（至少保留最近 N 个版本）
  * 语法校验（基础）
  * CSP 策略（减少 XSS 风险）
* 若系统支持多用户写作：User 不得编辑这两项

---

## 8. 评论与回复模块

### 8.1 基本能力

* 支持对文章发表评论
* 支持对评论回复（楼中楼）
* 支持分页加载、按时间排序（正序/倒序可选）

### 8.2 可见性与权限

* 评论可见性：

  * 只有当用户“有权限阅读文章”时，才允许读取该文章评论
* 评论发表权限：

  * 默认：仅登录用户（User/Admin）可发表
  * 可选：允许游客评论（需验证码+频控+审核）
* 删除/编辑：

  * 用户可删除自己的评论（是否允许编辑可配置；编辑需留痕可选）
  * Admin 可删除任何评论、可屏蔽/隐藏

### 8.3 审核与风控（建议作为 Admin 配置）

* 反垃圾：

  * 频率限制（同 IP、同用户）
  * 敏感词过滤（命中进入待审核/直接拒绝可选）
  * 黑名单（IP/用户）
* 审核模式：

  * 全部免审
  * 首评审核
  * 全部审核

### 8.4 通知（可选）

* 评论回复通知：

  * 站内通知（推荐）
  * 邮件通知（可选）

---

## 9. 主题系统（制作规则 + 导入导出）

### 9.1 主题目标

* “主题”决定站点整体外观与部分布局：颜色、字体、组件样式、页面模板
* Admin 可：

  * 安装/切换主题
  * 导出当前主题
  * 导入第三方主题包

### 9.2 主题包结构规则（建议标准化）

主题以一个可导入的压缩包（zip）为单位，包含：

* `theme.json`：主题元信息与配置项声明（名称、版本、作者、最低系统版本、可配置项 schema）
* `assets/`：静态资源（css、js、图片、字体）
* `templates/`：页面模板（首页、文章页、列表页、相册页、页面页等）
* `preview/`：预览图（可选）
* `i18n/`：多语言（可选）

> 前端是 Vite + Element：实现方式上可把主题视为“运行时加载的静态资源 + 模板配置”，或“构建时主题”（需要重新打包）。本设计建议 **运行时主题**，避免每次换主题都要重新构建部署。

### 9.3 主题切换生效范围

* 主题切换后影响：

  * 全站样式（基础 CSS、变量）
  * 页面布局模板（导航/页脚/文章页结构）
* 不影响：

  * 文章内容本身（Markdown/富文本内容不变）
  * 权限与数据

### 9.4 主题导入/导出行为

* 导入：

  * 校验 `theme.json`、版本兼容性
  * 解压到主题目录（或存储到数据库/对象存储）
  * 可选择立即启用或仅安装
* 导出：

  * 导出指定主题包（含 assets/templates/theme.json）
  * 可选择是否包含管理员自定义 CSS/JS（建议分离，不默认包含）

### 9.5 主题配置（可选但建议）

* 主题可声明可配置项，例如：

  * 主色、暗色模式、字体大小、首页布局模式
* Admin 在后台修改配置，实时生成主题变量（如 CSS variables）

---

## 10. 导航首页与页面管理、搜索引擎选择

### 10.1 导航首页（Portal）

* 首页可配置为：

  1. 博客流首页（文章列表）
  2. 导航门户首页（站点卡片 + 分类 + 搜索框）
  3. 主题自定义首页（由主题模板决定）

### 10.2 页面管理（自定义页面）

* 页面类型至少支持：

  * Markdown 页面
  * 富文本页面
  * 外链跳转页面（点击直接跳转到 URL）
* 页面具备：

  * 标题、slug/path、内容类型、内容
  * 可见性策略（同 2.3）
  * 是否显示在导航栏
  * 排序权重

### 10.3 搜索引擎选择与跳转规则

* Admin 可配置可选搜索引擎列表：

  * 例如：Google、Bing、百度、站内搜索
* 首页搜索框行为：

  * 选择引擎后，将关键字拼接到对应 query URL 并跳转
  * 若选站内搜索：跳转站内搜索页并传参
* 安全要求：

  * 外链白名单/协议限制（仅 http/https）
  * 防止注入（对关键字进行 URL 编码）

---

## 11. 后台管理（Admin Console）

至少包含以下管理页：

* 用户管理：列表、禁用/启用、角色设置、重置密码（或发送重置链接）
* 文章管理：审核（若启用）、编辑、下线、权限设置
* 评论管理：审核、删除、屏蔽、黑名单
* 相册管理：上传、批量处理、图床同步状态、重试
* 导航与页面：增删改查、排序、可见性
* 主题管理：安装、启用、配置、导入/导出
* 站点设置：

  * 站点名称/描述/logo
  * 自定义 CSS/JS
  * RSS 配置
  * SEO（可选）
  * 安全策略（游客评论、审核模式、频控阈值等）

---

## 12. 前后端交互与接口层（功能级约束）

> 不给出字段，但给出“接口必须保证的语义”。

### 12.1 通用要求

* 所有列表/详情接口必须做：

  * 可见性过滤（返回前过滤）
  * 分页与排序
  * 统一错误码（未登录/无权限/不存在/参数错误）

### 12.2 内容接口关键语义

* 文章详情接口必须返回：

  * `contentType`: MARKDOWN / RICH_TEXT
  * `renderedContent` 或 `contentRaw`（二选一，明确约定）
  * `visibility`（可选返回，用于作者/管理员 UI）
* 文章列表接口：

  * 对不可见文章必须完全不可见（不仅仅是不返回正文，而是列表项也不出现）

### 12.3 RSS 接口

* 公共 RSS：不需要鉴权
* 私有 RSS：通过 token 识别用户，token 必须可吊销、可过期

---

## 13. 安全与合规性（实现必备约束）

* XSS：

  * 富文本 HTML 必须清洗（白名单标签/属性）
  * Markdown 渲染后也需要防注入（禁用危险协议 javascript:)
* CSRF：

  * 若使用 JWT 且不使用 cookie，一般 CSRF 风险降低；若使用 cookie，需要 CSRF token
* 访问控制：

  * 每个资源类接口都必须有“资源级权限校验”
* 日志审计：

  * Admin 的关键操作（删文、删评、切主题、改自定义 JS、图床推送）需要审计日志
* 限流：

  * 登录、评论、上传等高风险接口限流

---

## 14. 配置项清单（建议实现为“站点配置”）

* 是否允许游客评论（默认否）
* 是否允许普通用户发文（默认可选）
* 是否允许普通用户创建相册（默认否）
* Admin 是否可访问 PRIVATE 内容（默认是，可配置）
* 评论审核模式（免审/首评/全审）
* 敏感词策略（拒绝/待审）
* RSS 是否输出全文（默认摘要）
* 自定义 JS 是否启用（默认关闭）
* 图床平台与仓库配置（Git/Gitee）
* 首页模式（博客流/导航/主题）

---

## 15. 验收标准（按功能点逐条可测）

1. **登录注册与权限**

   * Guest 访问 PUBLIC 内容正常；访问 LOGIN_ONLY 返回未登录/无权限
   * User 能看到 LOGIN_ONLY 内容；WHITELIST 仅名单内可见
   * Admin 能管理全部后台功能

2. **Markdown/富文本**

   * 发布两种类型文章；阅读页按类型正确渲染
   * 列表页与详情页不会混用渲染组件

3. **RSS**

   * 公共 RSS 只含 PUBLIC+PUBLISHED
   * 私有 RSS 需要 token，且 token 吊销后不可访问

4. **相册与图床**

   * Admin 上传后能生成缩略图
   * 异步推送到 Git/Gitee 成功后可访问外链；失败可重试

5. **自定义 CSS/JS**

   * CSS 注入全站生效
   * JS 默认关闭；开启后生效且可回滚

6. **评论与回复**

   * 只有能看文章的人能看评论
   * User 可删自己评论；Admin 可全局删除/审核

7. **主题**

   * 主题包按规则导入；启用后全站样式/布局整体变化
   * 可导出主题并在另一实例导入后效果一致（不含数据）

8. **导航与页面**

   * 可新增页面（markdown/富文本/外链），可配置可见性
   * 搜索引擎可选，跳转 URL 正确编码
